<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <title>üçú ÂÆ∂Á≥ª„É©„Éº„É°„É≥Â∑°„Çä</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      height: 100vh;
      height: 100dvh;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
      height: 100vh;
      height: 100dvh;
      background: white;
    }
    
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh; /* fallback for older browsers */
      height: 100dvh; /* dynamic viewport height - URL„Éê„ÉºËÄÉÊÖÆ */
      padding-top: env(safe-area-inset-top);
    }
    
    .header {
      background: #FF0000;
      color: #000000;
      padding: 12px 16px 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 0;
      color: #000000;
    }
    
    .content {
      flex: 1;
      overflow: hidden;
      position: relative;
    }
    
    .tab-content {
      height: 100%;
      overflow-y: auto;
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .bottom-nav {
      display: flex;
      background: white;
      border-top: 1px solid #e5e7eb;
      padding: 4px 0;
      padding-bottom: max(env(safe-area-inset-bottom), 4px);
    }
    
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 4px 8px;
      border: none;
      background: none;
      cursor: pointer;
      color: #9ca3af;
      transition: color 0.2s;
    }
    
    .nav-item.active {
      color: #3b82f6;
    }
    
    .nav-item svg {
      width: 22px;
      height: 22px;
      margin-bottom: 2px;
    }
    
    .nav-item span {
      font-size: 11px;
      font-weight: 500;
    }
    
    /* Map View */
    #map {
      height: 100%;
      width: 100%;
    }
    
    .map-view {
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
    }
    
    .map-container {
      position: relative;
      height: 60%; /* ÂàùÊúüÂÄ§: 60% */
      min-height: 30%;
      max-height: 85%;
    }
    
    .resize-handle {
      height: 16px;
      background: #f3f4f6;
      cursor: ns-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      border-top: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      position: relative;
      z-index: 1001;
      touch-action: none;
    }
    
    .resize-handle::before {
      content: '';
      width: 32px;
      height: 4px;
      background: #d1d5db;
      border-radius: 2px;
    }
    
    .resize-handle:active {
      background: #e5e7eb;
    }
    
    .map-overlay {
      position: absolute;
      z-index: 1000;
      pointer-events: none;
    }
    
    .map-title {
      top: 16px;
      left: 16px;
      background: rgba(255,255,255,0.95);
      padding: 8px 12px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .map-legend {
      top: 16px;
      right: 16px;
      background: rgba(255,255,255,0.95);
      padding: 8px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 12px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    
    .legend-item:last-child {
      margin-bottom: 0;
    }
    
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .shop-list-drawer {
      background: white;
      box-shadow: 0 -2px 16px rgba(0,0,0,0.1);
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 120px;
      overflow: hidden;
    }
    
    .drawer-handle {
      padding: 8px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .drawer-filter {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    
    .drawer-filter select {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      font-size: 14px;
    }
    
    .filter-toggle-btn {
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      font-size: 13px;
      background: white;
      color: #6b7280;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .filter-toggle-btn.active {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }
    
    .filter-toggle-btn:hover {
      background: #f3f4f6;
    }
    
    .filter-toggle-btn.active:hover {
      background: #059669;
    }
    
    .drawer-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px 16px 16px;
    }
    
    .shop-list-item {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #f9fafb;
      padding: 12px;
      border-radius: 16px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .shop-list-item:active {
      background: #f3f4f6;
    }
    
    .shop-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    
    .shop-icon.visited {
      background: #d1fae5;
    }
    
    .shop-icon.unvisited {
      background: #fee2e2;
    }
    
    .shop-info {
      flex: 1;
      min-width: 0;
    }
    
    .shop-name {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    
    .shop-name-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      min-width: 0;
    }
    
    .shop-name-badges {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }
    
    .shop-meta {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
      font-size: 12px;
      color: #6b7280;
    }
    
    .badge-open {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #10b981;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 4px;
    }
    
    .badge-soon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #f59e0b;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 4px;
    }
    
    .badge-want {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #fef3c7;
      color: #92400e;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 4px;
    }
    
    .badge-favorite {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #fce7f3;
      color: #9f1239;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 4px;
    }
    
    .badge-distance {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #e0f2fe;
      color: #075985;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 10px;
      margin-left: 4px;
    }
    
    /* Shop Detail Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      display: none;
      align-items: flex-end;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      width: 100%;
      max-height: 95vh;
      border-radius: 24px 24px 0 0;
      overflow-y: auto;
      overflow-x: hidden;
      animation: slideUp 0.3s ease-out;
      box-sizing: border-box;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }
    
    .modal-header {
      padding: 16px;
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .modal-handle {
      width: 48px;
      height: 4px;
      background: #d1d5db;
      border-radius: 2px;
      margin: 0 auto 16px;
    }
    
    .modal-title-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .modal-title {
      flex: 1;
    }
    
    .modal-title h2 {
      font-size: 24px;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 8px;
    }
    
    .modal-badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    
    .badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-category {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .badge-status {
      background: #10b981;
      color: white;
    }
    
    .badge-closed {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #9ca3af;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 4px;
    }
    
    .close-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #f3f4f6;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .modal-body {
      padding: 0 16px 24px;
    }
    
    .section {
      margin-bottom: 24px;
    }
    
    .section-title {
      font-weight: 600;
      font-size: 16px;
      color: #1f2937;
      margin-bottom: 12px;
    }
    
    .description {
      color: #4b5563;
      line-height: 1.6;
      font-size: 14px;
    }
    
    .hours-grid {
      background: #f9fafb;
      border-radius: 12px;
      padding: 12px;
    }
    
    .hours-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
    }
    
    .hours-row:last-child {
      border-bottom: none;
    }
    
    .hours-row.today {
      font-weight: bold;
      color: #3b82f6;
    }
    
    .hours-day {
      color: #6b7280;
    }
    
    .hours-time {
      color: #1f2937;
    }
    
    .hours-row.today .hours-day,
    .hours-row.today .hours-time {
      color: #3b82f6;
    }
    
    .visit-stats {
      display: grid;
      grid-template-columns: 23fr 54fr 23fr;
      gap: 12px;
      margin-top: 12px;
    }
    
    .visit-stats-inline {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 12px;
    }
    
    .stat-inline {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }
    
    .stat-inline-label {
      font-size: 13px;
      color: #6b7280;
    }
    
    .stat-inline-value {
      font-size: 18px;
      font-weight: bold;
      color: #1f2937;
    }
    
    .stat-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 12px;
    }
    
    .stat-label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #1f2937;
    }
    
    .stat-value-date {
      font-size: 18px;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .btn {
      flex: 1;
      padding: 14px;
      border-radius: 16px;
      border: none;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .btn:active {
      opacity: 0.8;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    
    .btn-secondary {
      background: #f3f4f6;
      color: #1f2937;
    }
    
    .btn-want {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .btn-want.active {
      background: #fef3c7;
      color: #92400e;
    }
    
    .btn-favorite {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .btn-favorite.active {
      background: #fce7f3;
      color: #9f1239;
    }
    
    .nav-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 12px;
    }
    
    .btn-nav {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-decoration: none;
      color: #1f2937;
    }
    
    .visit-history {
      margin-top: 16px;
    }
    
    .visit-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 8px;
    }
    
    .visit-date {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .visit-details {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    
    .visit-rating {
      display: flex;
      gap: 2px;
      margin: 8px 0;
    }
    
    .visit-order {
      font-size: 13px;
      color: #1f2937;
      margin-top: 8px;
      line-height: 1.5;
      background: #f3f4f6;
      padding: 8px 12px;
      border-radius: 8px;
    }
    
    .visit-memo {
      font-size: 13px;
      color: #4b5563;
      margin-top: 8px;
      line-height: 1.5;
    }
    
    .visit-photo {
      margin-top: 8px;
      border-radius: 8px;
      max-width: 100%;
      height: auto;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }
    
    /* Visit Record Modal */
    .record-modal .modal-content {
      max-height: 92vh;
    }
    
    .form-group {
      margin-bottom: 16px;
      box-sizing: border-box;
    }
    
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }
    
    .form-input {
      width: 100%;
      max-width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 15px;
      box-sizing: border-box;
    }
    
    input[type="datetime-local"].form-input {
      font-size: 14px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .datetime-input {
      width: 100%;
      max-width: 100%;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    textarea.form-input {
      min-height: 80px;
      resize: vertical;
    }
    
    .rating-input {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    .star-btn {
      background: none;
      border: none;
      font-size: 32px;
      cursor: pointer;
      padding: 0;
      color: #d1d5db;
      transition: transform 0.1s;
    }
    
    .star-btn.active {
      color: #fbbf24;
    }
    
    .star-btn:active {
      transform: scale(0.9);
    }
    
    .photo-upload {
      margin-top: 8px;
    }
    
    .photo-upload-btn {
      width: 100%;
      padding: 40px 20px;
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      background: #f9fafb;
      cursor: pointer;
      text-align: center;
      color: #6b7280;
      font-size: 14px;
    }
    
    .photo-preview {
      margin-top: 12px;
      position: relative;
    }
    
    .photo-preview img {
      width: 100%;
      border-radius: 12px;
    }
    
    .photo-remove {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    /* List Tab */
    .list-container {
      padding: 16px;
    }
    
    .shop-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
    }
    
    .shop-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .shop-card-title {
      flex: 1;
    }
    
    .shop-card-title h3 {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .check-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #10b981;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    /* Lineage Tab */
    .lineage-container {
      padding: 16px;
    }
    
    .lineage-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 24px;
    }
    
    .lineage-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 24px;
    }
    
    .lineage-root {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 32px;
    }
    
    .lineage-node {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      padding: 16px 32px;
      border-radius: 16px;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(239,68,68,0.3);
    }
    
    .lineage-line {
      width: 2px;
      height: 48px;
      background: #d1d5db;
    }
    
    .lineage-section {
      margin-bottom: 32px;
    }
    
    .lineage-section-title {
      text-align: center;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .lineage-shops {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
    }
    
    .lineage-shop {
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .lineage-shop.direct {
      background: #dbeafe;
      border: 1px solid #93c5fd;
    }
    
    .lineage-shop.direct.visited {
      background: #d1fae5;
      border: 2px solid #10b981;
    }
    
    .lineage-shop.derivative {
      background: #f3e8ff;
      border: 1px solid #d8b4fe;
    }
    
    .lineage-shop.derivative.visited {
      background: #d1fae5;
      border: 2px solid #10b981;
    }
    
    .lineage-shop-name {
      font-weight: 600;
      font-size: 13px;
      color: #1f2937;
      margin-bottom: 4px;
    }
    
    .lineage-shop-area {
      font-size: 11px;
      color: #6b7280;
    }
    
    .lineage-legend {
      margin-top: 24px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 12px;
    }
    
    .lineage-legend p {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 13px;
    }
    
    .lineage-legend ul {
      list-style: none;
      font-size: 12px;
      color: #6b7280;
    }
    
    .lineage-legend li {
      margin-bottom: 4px;
    }
    
    /* Stats Tab */
    .stats-container {
      padding: 16px;
    }
    
    .stats-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 24px;
      margin-bottom: 16px;
    }
    
    .stats-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 16px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .stat-box {
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-box.blue {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    }
    
    .stat-box.green {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    }
    
    .stat-box.yellow {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    }
    
    .stat-number {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .stat-box.blue .stat-number {
      color: #1e40af;
    }
    
    .stat-box.green .stat-number {
      color: #065f46;
    }
    
    .stat-box.yellow .stat-number {
      color: #92400e;
    }
    
    .stat-box-label {
      font-size: 11px;
      color: #4b5563;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="header">
      <h1>üçú ÂÆ∂Á≥ª„É©„Éº„É°„É≥map</h1>
    </div>
    
    <div class="content">
      <!-- Map Tab -->
      <div id="tab-map" class="tab-content active">
        <div class="map-view">
          <div class="map-container">
            <div id="map"></div>
            <div class="map-overlay map-legend">
              <div class="legend-item">
                <div class="legend-dot" style="background:#ef4444;"></div>
                <span>Êú™Ë®™Âïè</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background:#10b981;"></div>
                <span>Ë®™ÂïèÊ∏à„Åø</span>
              </div>
            </div>
          </div>
          <div class="resize-handle" id="resize-handle"></div>
          <div class="shop-list-drawer">
            <div class="drawer-handle">
              <div class="drawer-filter">
                <select id="filter-category">
                  <option value="all">„Åô„Åπ„Å¶Ë°®Á§∫</option>
                  <option value="Á∑èÊú¨Â±±">Á∑èÊú¨Â±±</option>
                  <option value="Áõ¥Á≥ª">Áõ¥Á≥ª</option>
                  <option value="ÊúâÂêçÂ∫ó">ÊúâÂêçÂ∫ó</option>
                  <option value="Ê¥æÁîü">Ê¥æÁîü</option>
                  <option value="want">‚òÜ Ë°å„Åç„Åü„ÅÑ</option>
                  <option value="favorite">‚ô° „ÅäÊ∞ó„Å´ÂÖ•„Çä</option>
                </select>
                <button class="filter-toggle-btn" id="btn-open-toggle">Âñ∂Ê•≠‰∏≠</button>
                <button class="filter-toggle-btn" id="btn-nearby">
                  <svg style="width:14px;height:14px;vertical-align:middle;margin-right:2px;" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                  </svg>‰ªä„Åã„Çâ
                </button>
              </div>
            </div>
            <div class="drawer-content" id="shop-list"></div>
          </div>
        </div>
      </div>
      
      <!-- List Tab -->
      <div id="tab-list" class="tab-content">
        <div style="padding:16px;background:#f9fafb;border-bottom:1px solid #e5e7eb;">
          <div style="display:flex;gap:6px;align-items:center;">
            <select id="list-filter-category" style="flex:1;padding:8px 12px;border:1px solid #e5e7eb;border-radius:12px;font-size:14px;">
              <option value="all">„Åô„Åπ„Å¶Ë°®Á§∫</option>
              <option value="Á∑èÊú¨Â±±">Á∑èÊú¨Â±±</option>
              <option value="Áõ¥Á≥ª">Áõ¥Á≥ª</option>
              <option value="ÊúâÂêçÂ∫ó">ÊúâÂêçÂ∫ó</option>
              <option value="Ê¥æÁîü">Ê¥æÁîü</option>
              <option value="want">‚òÜ Ë°å„Åç„Åü„ÅÑ</option>
              <option value="favorite">‚ô° „ÅäÊ∞ó„Å´ÂÖ•„Çä</option>
            </select>
            <button class="filter-toggle-btn" id="list-btn-open-toggle">Âñ∂Ê•≠‰∏≠</button>
            <button class="filter-toggle-btn" id="list-btn-nearby">
              <svg style="width:14px;height:14px;vertical-align:middle;margin-right:2px;" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
              </svg>‰ªä„Åã„Çâ
            </button>
          </div>
        </div>
        <div class="list-container" id="list-container"></div>
      </div>
      
      <!-- Lineage Tab -->
      <div id="tab-lineage" class="tab-content">
        <div class="lineage-container">
          <div class="lineage-card">
            <div class="lineage-title">ÂÆ∂Á≥ª„É©„Éº„É°„É≥Áõ∏Èñ¢Âõ≥</div>
            <div class="lineage-root">
              <div class="lineage-node">üçú ÂêâÊùëÂÆ∂ÔºàÁ∑èÊú¨Â±±Ôºâ</div>
              <div class="lineage-line"></div>
            </div>
            <div class="lineage-section">
              <div class="lineage-section-title">Áõ¥Á≥ªÂ∫ó</div>
              <div class="lineage-shops" id="lineage-direct"></div>
            </div>
            <div class="lineage-section">
              <div class="lineage-section-title">ÊúâÂêçÂ∫ó„ÉªÊ¥æÁîüÁ≥ª</div>
              <div class="lineage-shops" id="lineage-derivative"></div>
            </div>
            <div class="lineage-legend">
              <p>Âá°‰æã</p>
              <ul>
                <li>‚Ä¢ Á∑èÊú¨Â±±: ÂÆ∂Á≥ª„É©„Éº„É°„É≥Áô∫Á••„ÅÆÂêâÊùëÂÆ∂</li>
                <li>‚Ä¢ Áõ¥Á≥ªÂ∫ó: ÂêâÊùëÂÆ∂„Åã„ÇâÁõ¥Êé•ÊöñÁ∞æÂàÜ„Åë</li>
                <li>‚Ä¢ ÊúâÂêçÂ∫ó„ÉªÊ¥æÁîüÁ≥ª: ÂêâÊùëÂÆ∂‰ª•Â§ñ„Åã„ÇâÊ¥æÁîü„Åó„ÅüÂ∫óËàó</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Stats Tab -->
      <div id="tab-stats" class="tab-content">
        <div class="stats-container">
          <div class="stats-card">
            <div class="stats-title">Áµ±Ë®àÊÉÖÂ†±</div>
            <div class="stats-grid">
              <div class="stat-box blue">
                <div class="stat-number" id="stat-visited">0</div>
                <div class="stat-box-label">Ë®™ÂïèÂ∫óËàó</div>
              </div>
              <div class="stat-box green">
                <div class="stat-number" id="stat-percent">0%</div>
                <div class="stat-box-label">Âà∂Ë¶áÁéá</div>
              </div>
              <div class="stat-box yellow">
                <div class="stat-number" id="stat-rating">-</div>
                <div class="stat-box-label">Âπ≥ÂùáË©ï‰æ°</div>
              </div>
            </div>
            <div class="section-title">Ë®™ÂïèÂ±•Ê≠¥</div>
            <div id="visit-history-list"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="bottom-nav">
      <button class="nav-item active" data-tab="map">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        <span>„Éû„ÉÉ„Éó</span>
      </button>
      <button class="nav-item" data-tab="list">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
        <span>„É™„Çπ„Éà</span>
      </button>
      <button class="nav-item" data-tab="lineage">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12M8 12h12M8 17h12M3 7h.01M3 12h.01M3 17h.01"/>
        </svg>
        <span>Áõ∏Èñ¢Âõ≥</span>
      </button>
      <button class="nav-item" data-tab="stats">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
        </svg>
        <span>Áµ±Ë®à</span>
      </button>
    </div>
  </div>
  
  <!-- Shop Detail Modal -->
  <div id="shop-detail-modal" class="modal">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-handle"></div>
        <div class="modal-title-row">
          <div class="modal-title">
            <h2 id="detail-name"></h2>
            <div class="modal-badges">
              <span class="badge badge-category" id="detail-category"></span>
              <span id="detail-status-badge"></span>
            </div>
            <div style="display:flex;align-items:center;gap:4px;color:#6b7280;font-size:13px;margin-top:4px;">
              <svg style="width:14px;height:14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              </svg>
              <span id="detail-area"></span>
            </div>
          </div>
          <button class="close-btn" onclick="closeShopDetail()">‚úï</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="section">
          <p class="description" id="detail-description"></p>
        </div>
        
        <div class="section">
          <div class="section-title">Âñ∂Ê•≠ÊôÇÈñì</div>
          <div class="hours-grid" id="detail-hours"></div>
        </div>
        
        <div class="section">
          <div class="section-title">„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥</div>
          <div class="nav-buttons">
            <a class="btn-nav" id="nav-apple" href="#" target="_blank" rel="noopener noreferrer">
              <svg style="width:18px;height:18px;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <span>Apple„Éû„ÉÉ„Éó</span>
            </a>
            <a class="btn-nav" id="nav-google" href="#" target="_blank" rel="noopener noreferrer">
              <svg style="width:18px;height:18px;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <span>GoogleÁµåË∑ØÊ°àÂÜÖ</span>
            </a>
          </div>
        </div>
        
        <div class="section" id="link-section">
          <div class="section-title">„É™„É≥„ÇØ</div>
          <div class="nav-buttons">
            <a class="btn-nav" id="nav-google-map" href="#" target="_blank" rel="noopener noreferrer">
              <svg style="width:18px;height:18px;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
              </svg>
              <span>Google„Éû„ÉÉ„Éó</span>
            </a>
            <a class="btn-nav" id="nav-website" href="#" target="_blank" rel="noopener noreferrer">
              <svg style="width:18px;height:18px;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
              </svg>
              <span>„Éõ„Éº„É†„Éö„Éº„Ç∏</span>
            </a>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">Êù•Â∫óÊÉÖÂ†±</div>
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="openRecordModal()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:6px;">
              <svg style="width:18px;height:18px;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
              <span>Ë®™ÂïèË®òÈå≤</span>
            </button>
          </div>
          <div class="action-buttons" style="margin-top:8px;">
            <button class="btn btn-want" id="btn-want" onclick="toggleWantToGo()">
              <span id="want-icon">‚òÜ</span>
              <span>Ë°å„Åç„Åü„ÅÑ</span>
            </button>
            <button class="btn btn-favorite" id="btn-favorite" onclick="toggleFavorite()">
              <svg id="favorite-icon" style="width:16px;height:16px;vertical-align:middle;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
              </svg>
              <span style="margin-left:4px;">„ÅäÊ∞ó„Å´ÂÖ•„Çä</span>
            </button>
          </div>
          <div class="visit-stats">
            <div class="stat-card">
              <div class="stat-label">Êù•Â∫óÂõûÊï∞</div>
              <div class="stat-value" id="detail-visit-count">0</div>
            </div>
            <div class="stat-card stat-card-wide">
              <div class="stat-label">ÊúÄÁµÇÊù•Â∫ó</div>
              <div class="stat-value" id="detail-last-visit">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Âπ≥ÂùáË©ï‰æ°</div>
              <div class="stat-value" id="detail-avg-rating">-</div>
            </div>
          </div>
        </div>
        
        <div class="section" id="visit-history-section">
          <div class="section-title">Êù•Â∫óÂ±•Ê≠¥</div>
          <div class="visit-history" id="detail-visits"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Visit Record Modal -->
  <div id="record-modal" class="modal record-modal">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-handle"></div>
        <div class="modal-title-row">
          <div class="modal-title">
            <h2>Ë®™ÂïèË®òÈå≤</h2>
          </div>
          <button class="close-btn" onclick="closeRecordModal()">‚úï</button>
        </div>
      </div>
      <div class="modal-body">
        <form id="record-form">
          <div class="form-group">
            <label class="form-label">Êù•Â∫óÊó•ÊôÇ *</label>
            <input type="datetime-local" class="form-input datetime-input" id="input-visited-at" required>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Ê∞óÊ∏©Ôºà¬∞CÔºâ</label>
              <input type="number" class="form-input" id="input-temp" step="0.1" placeholder="‰æã: 25">
            </div>
            <div class="form-group">
              <label class="form-label">ÂæÖ„Å°ÊôÇÈñìÔºàÂàÜÔºâ</label>
              <input type="number" class="form-input" id="input-wait" min="0" placeholder="‰æã: 15">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Â§©Ê∞ó</label>
            <select class="form-input" id="input-weather">
              <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
              <option value="Êô¥„Çå">‚òÄÔ∏è Êô¥„Çå</option>
              <option value="Êõá„Çä">‚òÅÔ∏è Êõá„Çä</option>
              <option value="Èõ®">üåßÔ∏è Èõ®</option>
              <option value="Èõ™">‚ùÑÔ∏è Èõ™</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Ë©ï‰æ°</label>
            <div class="rating-input" id="rating-input"></div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Ê≥®ÊñáÂÜÖÂÆπ</label>
            <input type="text" class="form-input" id="input-order" placeholder="‰æã: „É©„Éº„É°„É≥ÔºàÈ∫∫Á°¨„ÇÅ„ÄÅÂë≥ÊøÉ„ÅÑ„ÇÅ„ÄÅÊ≤πÂ§ö„ÇÅÔºâ">
          </div>
          
          <div class="form-group">
            <label class="form-label">„É°„É¢</label>
            <textarea class="form-input" id="input-memo" placeholder="Âë≥„ÅÆÊÑüÊÉ≥„Å™„Å©..."></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">ÂÜôÁúü</label>
            <div class="photo-upload">
              <input type="file" id="input-photo" accept="image/*" style="display:none;" onchange="handlePhotoUpload(event)">
              <div class="photo-upload-btn" onclick="document.getElementById('input-photo').click()">
                üì∑ ÂÜôÁúü„ÇíËøΩÂä†
              </div>
              <div id="photo-preview" class="photo-preview" style="display:none;">
                <img id="preview-img" src="" alt="Preview">
                <button type="button" class="photo-remove" onclick="removePhoto()">‚úï</button>
              </div>
            </div>
          </div>
          
          <button type="button" class="btn btn-primary" style="width:100%;margin-top:16px;" onclick="saveVisitRecord(event)">‰øùÂ≠ò</button>
        </form>
      </div>
    </div>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script>
    // Shop Data
    const shops = [
      {
        id: "yoshimuraya",
        name: "ÂÆ∂Á≥ªÁ∑èÊú¨Â±± ÂêâÊùëÂÆ∂",
        category: "Á∑èÊú¨Â±±",
        area: "Ê®™ÊµúÈßÖË•øÂè£",
        lat: 35.4629487,
        lng: 139.6150264,
        parent: null,
        description: "1974Âπ¥ÂâµÊ•≠„ÅÆÂÆ∂Á≥ª„É©„Éº„É°„É≥Áô∫Á••Â∫ó„ÄÇÊøÉÂéöË±öÈ™®ÈÜ§Ê≤π„Çπ„Éº„Éó„Å´Â§™È∫∫„ÄÅÂ•Ω„Åø„ÇíË™øÁØÄ„Åß„Åç„ÇãÁã¨Ëá™„Çπ„Çø„Ç§„É´„ÇíÁ¢∫Á´ã„Åó„ÅüÂêçÂ∫ó„ÄÇ",
        googleMapUrl: "https://www.google.co.jp/maps/place/%E5%AE%B6%E7%B3%BB%E7%B7%8F%E6%9C%AC%E5%B1%B1+%E5%90%89%E6%9D%91%E5%AE%B6/@35.4629487,139.6150264,154m/data=!3m2!1e3!5s0x60185c0c430436f7:0xf13df3160648aa53!4m15!1m8!3m7!1s0x60185c0c4307d32f:0xc9ce8a60cdd2d672!2z5a6257O757eP5pys5bGxIOWQieadkeWutg!8m2!3d35.4630187!4d139.6150749!10e9!16s%2Fg%2F1tfg31bf!3m5!1s0x60185c0c4307d32f:0xc9ce8a60cdd2d672!8m2!3d35.4630187!4d139.6150749!16s%2Fg%2F1tfg31bf?hl=ja&entry=ttu&g_ep=EgoyMDI1MTIwOS4wIKXMDSoASAFQAw%3D%3D",
        websiteUrl: "http://ieke1.com/",
        openingHours: {
          mon: {times:[]},
          tue: {times:[{start:"11:00",end:"20:00"}]},
          wed: {times:[{start:"11:00",end:"20:00"}]},
          thu: {times:[{start:"11:00",end:"20:00"}]},
          fri: {times:[{start:"11:00",end:"20:00"}]},
          sat: {times:[{start:"11:00",end:"20:00"}]},
          sun: {times:[{start:"11:00",end:"20:00"}]}
        }
      },
      {
        id: "sugitaya",
        name: "ÊùâÁî∞ÂÆ∂Êú¨Â∫ó",
        category: "Áõ¥Á≥ª",
        area: "Êñ∞ÊùâÁî∞",
        lat: 35.3881631,
        lng: 139.6182152,
        parent: "yoshimuraya",
        description: "ÂêâÊùëÂÆ∂Áõ¥Á≥ªÁ¨¨1Âè∑Â∫ó„Å®„Åó„Å¶1999Âπ¥ÈñãÂ∫ó„ÄÇÊúù5ÊôÇ„Åã„ÇâÂñ∂Ê•≠„Åó„ÄÅÊøÉÂéö„Å™Ë±öÈ™®ÈÜ§Ê≤π„Çπ„Éº„Éó„ÅßË°åÂàó„ÅåÁµ∂„Åà„Å™„ÅÑËÄÅËàóÁõ¥Á≥ªÂ∫ó„ÄÇ",
        googleMapUrl: "https://www.google.co.jp/maps/place/%E6%9D%89%E7%94%B0%E5%AE%B6/@35.3881631,139.041433,158103m/data=!3m1!1e3!4m10!1m2!2m1!1z5p2J55Sw5a62!3m6!1s0x6018435d664217b9:0x50a70700f361edb7!8m2!3d35.3881631!4d139.6182152!15sCgnmnYnnlLDlrrYiA4gBAVoMIgrmnYnnlLAg5a62kgEQcmFtZW5fcmVzdGF1cmFudJoBRENpOURRVWxSUVVOdlpFTm9kSGxqUmpsdlQyc3dlV1ZJVmt0T2JHZDBVMFJHTkdSWFozcFNSRXAwVjFSYVdGWkhZeEFC4AEA-gEECAAQHQ!16s%2Fg%2F1z449y7b2?hl=ja&entry=ttu&g_ep=EgoyMDI1MTIwOS4wIKXMDSoASAFQAw%3D%3D",
        websiteUrl: "https://sugitaya.com/",
        openingHours: {
          mon: {times:[{start:"05:00",end:"22:00"}]},
          tue: {times:[{start:"05:00",end:"22:00"}]},
          wed: {times:[{start:"05:00",end:"22:00"}]},
          thu: {times:[{start:"05:00",end:"22:00"}]},
          fri: {times:[{start:"05:00",end:"22:00"}]},
          sat: {times:[{start:"05:00",end:"22:00"}]},
          sun: {times:[]}
        }
      },
      {
        id: "suehiroya",
        name: "Êú´Âª£ÂÆ∂",
        category: "Áõ¥Á≥ª",
        area: "ÂÖ≠ËßíÊ©ã",
        lat: 35.4880323,
        lng: 139.6221691,
        parent: "yoshimuraya",
        description: "ÂêâÊùëÂÆ∂Áõ¥Á≥ªÂ∫ó„ÅÆ‰∏Ä„Å§„ÄÇÂÖ≠ËßíÊ©ã„ÅßÊøÉÂéö„Å™Áõ¥Á≥ªÂÆ∂Á≥ª„É©„Éº„É°„É≥„ÇíÊèê‰æõ„Åó„ÄÅÁõ¥Á≥ªÁéãÈÅì„ÅÆÂë≥Á∂ôÊâøÂ∫ó„Å®„Åó„Å¶‰∫∫Ê∞ó„ÄÇ",
        googleMapUrl: "https://www.google.co.jp/maps/place/%E3%83%A9%E3%83%BC%E3%83%A1%E3%83%B3+%E6%9C%AB%E5%BB%A3%E5%AE%B6/@35.4880323,139.6221691,1234m/data=!3m2!1e3!4b1!4m6!3m5!1s0x60185ea40ab2abe7:0xa69bc35f35258466!8m2!3d35.4880323!4d139.624744!16s%2Fg%2F12qfxwkw6?hl=ja&entry=ttu&g_ep=EgoyMDI1MTIwOS4wIKXMDSoASAFQAw%3D%3D",
        websiteUrl: "https://x.com/2525_2929",
        openingHours: {
          mon: {times:[]},
          tue: {times:[{start:"11:00",end:"21:00"}]},
          wed: {times:[{start:"11:00",end:"21:00"}]},
          thu: {times:[{start:"11:00",end:"21:00"}]},
          fri: {times:[{start:"11:00",end:"21:00"}]},
          sat: {times:[{start:"11:00",end:"21:00"}]},
          sun: {times:[]}
        }
      },
      {
        id: "tsuruichiya-neo",
        name: "È∂¥‰∏ÄÂÆ∂ neo",
        category: "Áõ¥Á≥ª",
        area: "È∂¥Â±ãÁî∫",
        lat: 35.4694779,
        lng: 139.6208343,
        parent: "yoshimuraya",
        description: "Ê®™ÊµúÈßÖËøë„ÅèÈ∂¥Â±ãÁî∫„ÅÆÂÆ∂Á≥ª„É©„Éº„É°„É≥Â∫ó„ÄÇÊ∑±Â§ú„Åæ„ÅßÂñ∂Ê•≠„Åó„ÄÅÊøÉÂéö„Å™Ë±öÈ™®ÈÜ§Ê≤π„Çπ„Éº„Éó„ÅåÁâπÂæ¥„ÄÇ",
        googleMapUrl: "https://www.google.com/maps/place/%E9%B6%B4%E4%B8%80%E5%AE%B6+neo/@35.4694779,139.6208343,15z/data=!4m6!3m5!1s0x60185dd1f76c0b3b:0x56351e864f67679e!8m2!3d35.4694779!4d139.6208343!16s%252Fg%252F11xkgw9v4y?hl=ja",
        websiteUrl: "",
        openingHours: {
          mon: {times:[{start:"10:00",end:"07:00"}]},
          tue: {times:[{start:"10:00",end:"07:00"}]},
          wed: {times:[{start:"10:00",end:"07:00"}]},
          thu: {times:[{start:"10:00",end:"07:00"}]},
          fri: {times:[{start:"10:00",end:"07:00"}]},
          sat: {times:[{start:"10:00",end:"07:00"}]},
          sun: {times:[{start:"10:00",end:"07:00"}]}
        }
      },
      {
        id: "oudou-kidouya",
        name: "È¨ºÈÅìÂÆ∂",
        category: "ÊúâÂêçÂ∫ó",
        area: "‰ªôÂè∞",
        lat: 38.2645786,
        lng: 140.8666282,
        parent: "yoshimuraya",
        description: "‰ªôÂè∞„Å´„Ç™„Éº„Éó„É≥„Åó„ÅüÁéãÈÅìÂÆ∂Á≥ªÁµ±„ÅÆ„ÅäÂ∫ó„ÄÇ",
        googleMapUrl: "https://www.google.com/maps/place/%E9%AC%BC%E9%81%93%E5%AE%B6/@38.2645786,140.8666282,16z/data=!4m6!3m5!1s0x5f89877591c28d59:0xf2d316766b1b9666!8m2!3d38.2645786!4d140.8666282!16s%2Fg%2F11bbxlkl66?entry=ttu&g_ep=EgoyMDI2MDEwNi4wIKXMDSoASAFQAw%3D%3D",
        websiteUrl: "https://x.com/kidouya_sendai",
        openingHours: {
          mon: {times:[{start:"11:00",end:"14:30"},{start:"17:00",end:"01:00"}]},
          tue: {times:[{start:"11:00",end:"14:30"},{start:"17:00",end:"01:00"}]},
          wed: {times:[{start:"11:00",end:"14:30"},{start:"17:00",end:"01:00"}]},
          thu: {times:[{start:"11:00",end:"14:30"},{start:"17:00",end:"01:00"}]},
          fri: {times:[{start:"11:00",end:"14:30"},{start:"17:00",end:"01:00"}]},
          sat: {times:[{start:"11:00",end:"15:00"},{start:"15:30",end:"01:00"}]},
          sun: {times:[{start:"11:00",end:"15:00"},{start:"15:30",end:"01:00"}]}
        }
      }
    ];
    
    // State
    let visits = JSON.parse(localStorage.getItem('iekei-visits') || '{}');
    let map = null;
    let markers = {};
    let currentShop = null;
    let currentRating = 0;
    let currentPhoto = null;
    let editingLogIndex = null; // Á∑®ÈõÜ‰∏≠„ÅÆ„É≠„Ç∞„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
    let showOpenOnly = false; // Âñ∂Ê•≠‰∏≠„Éï„Ç£„É´„Çø
    let userLocation = null; // „É¶„Éº„Ç∂„Éº‰ΩçÁΩÆ
    let userMarker = null; // „É¶„Éº„Ç∂„Éº‰ΩçÁΩÆ„Éû„Éº„Ç´„Éº
    let nearbyMode = false; // ‰ªä„Åã„Çâ„É¢„Éº„Éâ
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      initTabs();
      renderShopList();
      renderListTab();
      renderLineageTab();
      renderStatsTab();
      initRecordForm();
      initResizeHandle();
      
      // „Ç´„ÉÜ„Ç¥„É™„Éº„Éï„Ç£„É´„Çø
      document.getElementById('filter-category').addEventListener('change', () => {
        renderShopList();
        updateMarkers();
      });
      
      // Âñ∂Ê•≠‰∏≠„Éï„Ç£„É´„Çø
      document.getElementById('btn-open-toggle').addEventListener('click', () => {
        showOpenOnly = !showOpenOnly;
        document.getElementById('btn-open-toggle').classList.toggle('active');
        document.getElementById('list-btn-open-toggle')?.classList.toggle('active');
        renderShopList();
        updateMarkers();
        renderListTab();
      });
      
      // ‰ªä„Åã„Çâ„Éú„Çø„É≥
      document.getElementById('btn-nearby').addEventListener('click', () => {
        handleNearbyMode();
      });
      
      // „É™„Çπ„Éà„Çø„Éñ„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Éº„Éï„Ç£„É´„Çø
      document.getElementById('list-filter-category')?.addEventListener('change', () => {
        renderListTab();
      });
      
      // „É™„Çπ„Éà„Çø„Éñ„ÅÆÂñ∂Ê•≠‰∏≠„Éï„Ç£„É´„Çø
      document.getElementById('list-btn-open-toggle')?.addEventListener('click', () => {
        showOpenOnly = !showOpenOnly;
        document.getElementById('btn-open-toggle').classList.toggle('active');
        document.getElementById('list-btn-open-toggle').classList.toggle('active');
        renderShopList();
        updateMarkers();
        renderListTab();
      });
      
      // „É™„Çπ„Éà„Çø„Éñ„ÅÆ‰ªä„Åã„Çâ„Éú„Çø„É≥
      document.getElementById('list-btn-nearby')?.addEventListener('click', () => {
        handleNearbyMode();
      });
      
      // „É¢„Éº„ÉÄ„É´„ÅÆ„Çπ„ÉØ„Ç§„Éó„ÅßÈñâ„Åò„Çã
      initModalSwipe();
    });
    
    // Tab Navigation
    function initTabs() {
      document.querySelectorAll('.nav-item').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          
          document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
          
          btn.classList.add('active');
          document.getElementById(`tab-${tab}`).classList.add('active');
          
          if (tab === 'map' && map) {
            setTimeout(() => map.invalidateSize(), 100);
          }
          
          if (tab === 'stats') {
            renderStatsTab();
          }
        });
      });
    }
    
    function initModalSwipe() {
      const modals = [
        { id: 'shop-detail-modal', closeFunc: closeShopDetail },
        { id: 'record-modal', closeFunc: closeRecordModal }
      ];
      
      modals.forEach(({ id, closeFunc }) => {
        const modal = document.getElementById(id);
        const modalContent = modal.querySelector('.modal-content');
        const modalHandle = modalContent.querySelector('.modal-handle');
        
        if (!modalHandle) return;
        
        let startY = 0;
        let currentY = 0;
        let isDragging = false;
        let startTime = 0;
        
        modalHandle.addEventListener('touchstart', (e) => {
          startY = e.touches[0].clientY;
          startTime = Date.now();
          isDragging = true;
          modalContent.style.transition = 'none';
        }, { passive: true });
        
        modalContent.addEventListener('touchstart', (e) => {
          // modal-headerÂÜÖ„Åß„ÅÆ„Åø„Çπ„ÉØ„Ç§„Éó„ÇíÊúâÂäπÂåñ
          const target = e.target;
          const header = modalContent.querySelector('.modal-header');
          
          if (header && header.contains(target)) {
            startY = e.touches[0].clientY;
            startTime = Date.now();
            isDragging = true;
            modalContent.style.transition = 'none';
          }
        }, { passive: true });
        
        document.addEventListener('touchmove', (e) => {
          if (!isDragging) return;
          
          const touch = e.touches[0];
          currentY = touch.clientY;
          const diff = currentY - startY;
          
          // ‰∏ãÊñπÂêë„ÅÆ„Åø
          if (diff > 0) {
            e.preventDefault();
            modalContent.style.transform = `translateY(${diff}px)`;
          }
        }, { passive: false });
        
        document.addEventListener('touchend', () => {
          if (!isDragging) return;
          
          const diff = currentY - startY;
          const duration = Date.now() - startTime;
          const velocity = diff / duration; // px/ms
          
          // 150px‰ª•‰∏ä„Çπ„ÉØ„Ç§„Éó „Åæ„Åü„ÅØ ÈÄü„ÅÑ„Çπ„ÉØ„Ç§„ÉóÔºà0.5px/ms‰ª•‰∏äÔºâ„ÅßÈñâ„Åò„Çã
          if (diff > 150 || (diff > 50 && velocity > 0.5)) {
            modalContent.style.transition = 'transform 0.3s ease';
            modalContent.style.transform = 'translateY(100%)';
            setTimeout(() => {
              closeFunc();
              modalContent.style.transform = '';
              modalContent.style.transition = '';
            }, 300);
          } else {
            // ÂÖÉ„Å´Êàª„Åô
            modalContent.style.transition = 'transform 0.3s ease';
            modalContent.style.transform = '';
            setTimeout(() => {
              modalContent.style.transition = '';
            }, 300);
          }
          
          isDragging = false;
          startY = 0;
          currentY = 0;
        }, { passive: true });
      });
    }
    
    // Map Functions
    function initMap() {
      map = L.map('map').setView([35.45, 139.62], 11);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap',
        maxZoom: 19
      }).addTo(map);
      
      updateMarkers();
    }
    
    function initResizeHandle() {
      const handle = document.getElementById('resize-handle');
      const mapContainer = document.querySelector('.map-container');
      const mapView = document.querySelector('.map-view');
      
      let isResizing = false;
      let startY = 0;
      let startHeight = 0;
      
      // „Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà
      handle.addEventListener('mousedown', startResize);
      
      // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà
      handle.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startResize(e.touches[0]);
      });
      
      function startResize(e) {
        isResizing = true;
        startY = e.clientY || e.pageY;
        startHeight = mapContainer.offsetHeight;
        
        document.body.style.userSelect = 'none';
        document.body.style.cursor = 'ns-resize';
        
        document.addEventListener('mousemove', doResize);
        document.addEventListener('mouseup', stopResize);
        document.addEventListener('touchmove', handleTouchMove);
        document.addEventListener('touchend', stopResize);
      }
      
      function handleTouchMove(e) {
        e.preventDefault();
        doResize(e.touches[0]);
      }
      
      function doResize(e) {
        if (!isResizing) return;
        
        const currentY = e.clientY || e.pageY;
        const diff = currentY - startY;
        const newHeight = startHeight + diff;
        const viewHeight = mapView.offsetHeight;
        const percentage = (newHeight / viewHeight) * 100;
        
        // 30%„Äú85%„ÅÆÁØÑÂõ≤„Å´Âà∂Èôê
        if (percentage >= 30 && percentage <= 85) {
          mapContainer.style.height = percentage + '%';
          
          // Âú∞Âõ≥„ÅÆ„Çµ„Ç§„Ç∫„ÇíÊõ¥Êñ∞
          if (map) {
            setTimeout(() => map.invalidateSize(), 0);
          }
        }
      }
      
      function stopResize() {
        isResizing = false;
        document.body.style.userSelect = '';
        document.body.style.cursor = '';
        
        document.removeEventListener('mousemove', doResize);
        document.removeEventListener('mouseup', stopResize);
        document.removeEventListener('touchmove', handleTouchMove);
        document.removeEventListener('touchend', stopResize);
      }
    }
    
    function updateMarkers() {
      Object.values(markers).forEach(m => m.remove());
      markers = {};
      
      const categoryFilter = document.getElementById('filter-category').value;
      let filteredShops;
      
      if (categoryFilter === 'want') {
        // Ë°å„Åç„Åü„ÅÑÂ∫ó„ÅÆ„Åø
        filteredShops = shops.filter(s => visits[s.id]?.wantToGo);
      } else if (categoryFilter === 'favorite') {
        // „ÅäÊ∞ó„Å´ÂÖ•„ÇäÂ∫ó„ÅÆ„Åø
        filteredShops = shops.filter(s => visits[s.id]?.favorite);
      } else if (categoryFilter === 'all') {
        filteredShops = [...shops];
      } else {
        filteredShops = shops.filter(s => s.category === categoryFilter);
      }
      
      // Âñ∂Ê•≠‰∏≠„Åæ„Åü„ÅØ‰ªä„Åã„Çâ„É¢„Éº„Éâ„ÅÆÂ†¥Âêà
      if (showOpenOnly || nearbyMode) {
        filteredShops = filteredShops.filter(shop => isOpenNow(shop.openingHours));
      }
      
      filteredShops.forEach(shop => {
        const visitData = visits[shop.id];
        const isVisited = visitData?.logs?.length > 0;
        const color = isVisited ? '#10b981' : '#ef4444';
        const icon = isVisited ? '‚úì' : 'üçú';
        
        // Êú¨Êó•„ÅÆÂñ∂Ê•≠ÊôÇÈñì„ÇíÂèñÂæó
        const todayHours = getTodayHours(shop.openingHours);
        
        const divIcon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="width:40px;height:40px;border-radius:50%;background:${color};border:3px solid white;box-shadow:0 4px 12px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;font-weight:bold;cursor:pointer">${icon}</div>`,
          iconSize: [40, 40],
          iconAnchor: [20, 40]
        });
        
        const popupId = `popup-${shop.id}`;
        const popup = `<div style="padding:8px;min-width:200px;position:relative;">
          <button onclick="markers['${shop.id}'].closePopup(); event.stopPropagation();" style="position:absolute;top:4px;right:4px;width:24px;height:24px;border:none;background:#f3f4f6;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;color:#6b7280;padding:0;">√ó</button>
          <div style="font-weight:bold;font-size:16px;margin-bottom:8px;padding-right:28px;">${shop.name}</div>
          <div style="font-size:12px;margin-bottom:8px">
            <span style="background:#dbeafe;color:#1e40af;padding:4px 8px;border-radius:12px;margin-right:8px">${shop.category}</span>
            <span style="color:#6b7280">${shop.area}</span>
          </div>
          <div style="font-size:12px;color:#6b7280;margin-bottom:12px">
            <strong>Êú¨Êó•:</strong> ${todayHours}
          </div>
          <button onclick="showShopDetail('${shop.id}')" style="width:100%;background:#3b82f6;color:white;padding:10px;border:none;border-radius:12px;font-weight:600;cursor:pointer">Ë©≥Á¥∞„ÉªË®™ÂïèË®òÈå≤</button>
        </div>`;
        
        const marker = L.marker([shop.lat, shop.lng], { icon: divIcon })
          .addTo(map)
          .bindPopup(popup, { closeButton: false });
        
        markers[shop.id] = marker;
      });
    }
    
    function renderShopList() {
      const container = document.getElementById('shop-list');
      const categoryFilter = document.getElementById('filter-category').value;
      
      let filteredShops;
      
      if (categoryFilter === 'want') {
        // Ë°å„Åç„Åü„ÅÑÂ∫ó„ÅÆ„Åø
        filteredShops = shops.filter(s => visits[s.id]?.wantToGo);
      } else if (categoryFilter === 'favorite') {
        // „ÅäÊ∞ó„Å´ÂÖ•„ÇäÂ∫ó„ÅÆ„Åø
        filteredShops = shops.filter(s => visits[s.id]?.favorite);
      } else if (categoryFilter === 'all') {
        filteredShops = [...shops];
      } else {
        filteredShops = shops.filter(s => s.category === categoryFilter);
      }
      
      // Âñ∂Ê•≠‰∏≠„Éï„Ç£„É´„Çø
      if (showOpenOnly) {
        filteredShops = filteredShops.filter(shop => isOpenNow(shop.openingHours));
      }
      
      // ‰ªä„Åã„Çâ„É¢„Éº„ÉâÔºöÂñ∂Ê•≠‰∏≠ + Ë∑ùÈõ¢È†Ü
      if (nearbyMode && userLocation) {
        filteredShops = filteredShops.filter(shop => isOpenNow(shop.openingHours));
        filteredShops = filteredShops.map(shop => ({
          ...shop,
          distance: calculateDistance(userLocation.lat, userLocation.lng, shop.lat, shop.lng)
        })).sort((a, b) => a.distance - b.distance);
      }
      
      container.innerHTML = filteredShops.map(shop => {
        const visitData = visits[shop.id];
        const isVisited = visitData?.logs?.length > 0;
        const openStatus = getOpenStatus(shop.openingHours);
        const isOpen = openStatus.state !== 'closed';
        const isSoon = openStatus.state === 'soon';
        const wantToGo = visitData?.wantToGo || false;
        const favorite = visitData?.favorite || false;
        
        return `
          <div class="shop-list-item" onclick="focusShop('${shop.id}')">
            <div class="shop-icon ${isVisited ? 'visited' : 'unvisited'}">
              ${isVisited ? '‚úì' : 'üçú'}
            </div>
            <div class="shop-info">
              <div class="shop-name">
                <span class="shop-name-text">${shop.name}</span>
                <div class="shop-name-badges">
                  ${wantToGo ? '<svg style="width:16px;height:16px;color:#eab308;" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>' : ''}
                  ${favorite ? '<svg style="width:16px;height:16px;color:#ec4899;" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>' : ''}
                </div>
              </div>
              <div class="shop-meta">
                <span class="badge badge-category">${shop.category}</span>
                <svg style="width:14px;height:14px;color:#6b7280;margin-left:4px;margin-right:-2px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                </svg>
                <span style="color:#6b7280;font-size:13px;">${shop.area}</span>
                ${isSoon ? '<span class="badge-soon">ÈñâÂ∫óÈñìËøë</span>' : (isOpen ? '<span class="badge-open">Âñ∂Ê•≠‰∏≠</span>' : '<span class="badge-closed">Âñ∂Ê•≠ÊôÇÈñìÂ§ñ</span>')}
                ${nearbyMode && shop.distance !== undefined ? `<span class="badge-distance">${shop.distance.toFixed(1)}km</span>` : ''}
              </div>
            </div>
            <svg style="width:20px;height:20px;color:#9ca3af;flex-shrink:0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </div>
        `;
      }).join('');
    }
    
    function focusShop(shopId) {
      const shop = shops.find(s => s.id === shopId);
      if (shop && markers[shopId]) {
        map.setView([shop.lat, shop.lng], 15, { animate: true });
        markers[shopId].openPopup();
      }
    }
    
    function calculateDistance(lat1, lng1, lat2, lng2) {
      // HaversineÂÖ¨Âºè„ÅßË∑ùÈõ¢„ÇíË®àÁÆóÔºàkmÂçò‰ΩçÔºâ
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    
    function handleNearbyMode() {
      if (nearbyMode) {
        // „Ç™„Éï„Å´„Åô„Çã
        nearbyMode = false;
        showOpenOnly = false;
        document.getElementById('btn-nearby').classList.remove('active');
        document.getElementById('btn-open-toggle').classList.remove('active');
        document.getElementById('list-btn-nearby')?.classList.remove('active');
        document.getElementById('list-btn-open-toggle')?.classList.remove('active');
        
        // „É¶„Éº„Ç∂„Éº„Éû„Éº„Ç´„Éº„ÇíÂâäÈô§
        if (userMarker) {
          userMarker.remove();
          userMarker = null;
        }
        userLocation = null;
        
        renderShopList();
        updateMarkers();
        renderListTab();
      } else {
        // „Ç™„É≥„Å´„Åô„Çã - ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó
        if (!navigator.geolocation) {
          alert('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
          return;
        }
        
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            
            nearbyMode = true;
            showOpenOnly = true;
            document.getElementById('btn-nearby').classList.add('active');
            document.getElementById('btn-open-toggle').classList.add('active');
            document.getElementById('list-btn-nearby')?.classList.add('active');
            document.getElementById('list-btn-open-toggle')?.classList.add('active');
            
            // Âú∞Âõ≥„Å´Èùí„ÅÑÁÇπ„ÇíË°®Á§∫
            if (userMarker) {
              userMarker.remove();
            }
            
            const userIcon = L.divIcon({
              className: 'user-marker',
              html: '<div style="width:16px;height:16px;border-radius:50%;background:#3b82f6;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
              iconSize: [16, 16],
              iconAnchor: [8, 8]
            });
            
            userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(map);
            
            // Âú∞Âõ≥„ÇíÁèæÂú®Âú∞‰∏≠ÂøÉ„Å´
            map.setView([userLocation.lat, userLocation.lng], 13, { animate: true });
            
            renderShopList();
            updateMarkers();
            renderListTab();
          },
          (error) => {
            let errorMessage = '‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\n';
            
            if (error.code === 1) {
              // PERMISSION_DENIED
              errorMessage += 'ÂéüÂõ†: ‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂà©Áî®„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ\n\n';
              errorMessage += 'ÂØæÂá¶Ê≥ï:\n';
              errorMessage += '1. „Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç¢„Éâ„É¨„Çπ„Éê„ÉºÂ∑¶ÂÅ¥„ÅÆ„Ç¢„Ç§„Ç≥„É≥„Çí„Çø„ÉÉ„Éó\n';
              errorMessage += '2. „Äå‰ΩçÁΩÆÊÉÖÂ†±„Äç„ÅÆË®≠ÂÆö„Çí„ÄåË®±ÂèØ„Äç„Å´Â§âÊõ¥\n';
              errorMessage += '3. „Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ';
            } else if (error.code === 2) {
              // POSITION_UNAVAILABLE
              errorMessage += 'ÂéüÂõ†: ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\n\n';
              errorMessage += 'ÂØæÂá¶Ê≥ï:\n';
              errorMessage += '1. „Éá„Éê„Ç§„Çπ„ÅÆ‰ΩçÁΩÆÊÉÖÂ†±„Çµ„Éº„Éì„Çπ„Åå„Ç™„É≥„Å´„Å™„Å£„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç\n';
              errorMessage += '2. Wi-Fi„Åæ„Åü„ÅØ„É¢„Éê„Ç§„É´„Éá„Éº„ÇøÈÄö‰ø°„Åå„Ç™„É≥„ÅãÁ¢∫Ë™ç';
            } else if (error.code === 3) {
              // TIMEOUT
              errorMessage += 'ÂéüÂõ†: ‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ\n\n';
              errorMessage += 'ÂØæÂá¶Ê≥ï: „ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
            }
            
            alert(errorMessage);
            console.error('Geolocation error:', error);
          }
        );
      }
    }
    
    // List Tab
    function renderListTab() {
      const container = document.getElementById('list-container');
      const categoryFilter = document.getElementById('list-filter-category')?.value || 'all';
      
      let filteredShops;
      
      if (categoryFilter === 'want') {
        // Ë°å„Åç„Åü„ÅÑÂ∫ó„ÅÆ„Åø
        filteredShops = shops.filter(s => visits[s.id]?.wantToGo);
      } else if (categoryFilter === 'favorite') {
        // „ÅäÊ∞ó„Å´ÂÖ•„ÇäÂ∫ó„ÅÆ„Åø
        filteredShops = shops.filter(s => visits[s.id]?.favorite);
      } else if (categoryFilter === 'all') {
        filteredShops = [...shops];
      } else {
        filteredShops = shops.filter(s => s.category === categoryFilter);
      }
      
      // Âñ∂Ê•≠‰∏≠„Éï„Ç£„É´„ÇøÔºà„É™„Çπ„Éà„Çø„ÉñÁî®Ôºâ
      if (showOpenOnly) {
        filteredShops = filteredShops.filter(shop => isOpenNow(shop.openingHours));
      }
      
      // ‰ªä„Åã„Çâ„É¢„Éº„ÉâÔºöÂñ∂Ê•≠‰∏≠ + Ë∑ùÈõ¢È†Ü
      if (nearbyMode && userLocation) {
        filteredShops = filteredShops.filter(shop => isOpenNow(shop.openingHours));
        filteredShops = filteredShops.map(shop => ({
          ...shop,
          distance: calculateDistance(userLocation.lat, userLocation.lng, shop.lat, shop.lng)
        })).sort((a, b) => a.distance - b.distance);
      }
      
      container.innerHTML = filteredShops.map(shop => {
        const visitData = visits[shop.id];
        const isVisited = visitData?.logs?.length > 0;
        const openStatus = getOpenStatus(shop.openingHours);
        const isOpen = openStatus.state !== 'closed';
        const isSoon = openStatus.state === 'soon';
        const todayHours = getTodayHours(shop.openingHours);
        const wantToGo = visitData?.wantToGo || false;
        const favorite = visitData?.favorite || false;
        
        // Âñ∂Ê•≠ÊôÇÈñì„ÅÆË°®Á§∫ÊñáË®Ä
        let hoursText = '';
        if (isOpen) {
          hoursText = `Êú¨Êó•: ${todayHours}`;
        } else {
          hoursText = todayHours === 'ÂÆö‰ºëÊó•' ? 'ÂÆö‰ºëÊó•' : 'Âñ∂Ê•≠ÁµÇ‰∫Ü';
        }
        
        return `
          <div class="shop-list-item" onclick="showShopDetail('${shop.id}')">
            <div class="shop-icon ${isVisited ? 'visited' : 'unvisited'}">
              ${isVisited ? '‚úì' : 'üçú'}
            </div>
            <div class="shop-info">
              <div class="shop-name">
                <span class="shop-name-text">${shop.name}</span>
                <div class="shop-name-badges">
                  ${wantToGo ? '<svg style="width:16px;height:16px;color:#eab308;" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>' : ''}
                  ${favorite ? '<svg style="width:16px;height:16px;color:#ec4899;" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>' : ''}
                </div>
              </div>
              <div class="shop-meta">
                <span class="badge badge-category">${shop.category}</span>
                <svg style="width:14px;height:14px;color:#6b7280;margin-left:4px;margin-right:-2px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                </svg>
                <span style="color:#6b7280;font-size:13px;">${shop.area}</span>
                ${isSoon ? '<span class="badge-soon">ÈñâÂ∫óÈñìËøë</span>' : (isOpen ? '<span class="badge-open">Âñ∂Ê•≠‰∏≠</span>' : '<span class="badge-closed">Âñ∂Ê•≠ÊôÇÈñìÂ§ñ</span>')}
                ${nearbyMode && shop.distance !== undefined ? `<span class="badge-distance">${shop.distance.toFixed(1)}km</span>` : ''}
              </div>
              <div style="color:#6b7280;font-size:12px;margin-top:4px;">${hoursText}</div>
            </div>
            <svg style="width:20px;height:20px;color:#9ca3af;flex-shrink:0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </div>
        `;
      }).join('');
    }
    
    // Lineage Tab
    function renderLineageTab() {
      const directShops = shops.filter(s => s.category === 'Áõ¥Á≥ª' && s.parent === 'yoshimuraya');
      const derivativeShops = shops.filter(s => (s.category === 'Ê¥æÁîü' || s.category === 'ÊúâÂêçÂ∫ó') && s.parent === 'yoshimuraya');
      
      document.getElementById('lineage-direct').innerHTML = directShops.map(shop => {
        const isVisited = visits[shop.id]?.logs?.length > 0;
        return `
          <div class="lineage-shop direct ${isVisited ? 'visited' : ''}">
            <div class="lineage-shop-name">${shop.name}</div>
            <div class="lineage-shop-area">${shop.area}</div>
          </div>
        `;
      }).join('');
      
      document.getElementById('lineage-derivative').innerHTML = derivativeShops.map(shop => {
        const isVisited = visits[shop.id]?.logs?.length > 0;
        return `
          <div class="lineage-shop derivative ${isVisited ? 'visited' : ''}">
            <div class="lineage-shop-name">${shop.name}</div>
            <div class="lineage-shop-area">${shop.area}</div>
          </div>
        `;
      }).join('');
    }
    
    // Stats Tab
    function renderStatsTab() {
      const visitedShops = Object.entries(visits).filter(([_, v]) => v.logs?.length > 0);
      const visitedCount = visitedShops.length;
      const totalShops = shops.length;
      const percent = ((visitedCount / totalShops) * 100).toFixed(0);
      
      const allRatings = visitedShops.flatMap(([_, v]) => 
        v.logs.filter(log => log.rating > 0).map(log => log.rating)
      );
      const avgRating = allRatings.length > 0 
        ? (allRatings.reduce((a, b) => a + b, 0) / allRatings.length).toFixed(1)
        : '-';
      
      document.getElementById('stat-visited').textContent = visitedCount;
      document.getElementById('stat-percent').textContent = `${percent}%`;
      document.getElementById('stat-rating').textContent = avgRating;
      
      const historyHTML = visitedShops
        .sort((a, b) => {
          const aLast = a[1].logs[a[1].logs.length - 1]?.visitedAt || '';
          const bLast = b[1].logs[b[1].logs.length - 1]?.visitedAt || '';
          return bLast.localeCompare(aLast);
        })
        .map(([shopId, visit]) => {
          const shop = shops.find(s => s.id === shopId);
          const lastVisit = visit.logs[visit.logs.length - 1];
          
          return `
            <div class="visit-card">
              <div style="display:flex;justify-content:space-between;align-items:start;">
                <div style="flex:1;">
                  <div style="font-weight:600;margin-bottom:4px;">${shop.name}</div>
                  <div style="font-size:12px;color:#6b7280;">
                    ${formatDate(lastVisit.visitedAt)} ‚Ä¢ ${visit.logs.length}ÂõûË®™Âïè
                  </div>
                </div>
                ${lastVisit.rating > 0 ? `
                  <div style="display:flex;align-items:center;gap:4px;background:#fef3c7;padding:4px 8px;border-radius:12px;">
                    <svg style="width:12px;height:12px;fill:#fbbf24;" viewBox="0 0 24 24">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    <span style="font-size:12px;font-weight:600;color:#92400e;">${lastVisit.rating}</span>
                  </div>
                ` : ''}
              </div>
              ${lastVisit.memo ? `<div style="font-size:13px;color:#4b5563;margin-top:8px;line-height:1.5;">${lastVisit.memo}</div>` : ''}
            </div>
          `;
        }).join('');
      
      document.getElementById('visit-history-list').innerHTML = historyHTML || 
        '<div class="empty-state"><div class="empty-state-icon">üçú</div><div>„Åæ„Å†Ë®™ÂïèË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div></div>';
    }
    
    // Shop Detail Modal
    function showShopDetail(shopId) {
      currentShop = shops.find(s => s.id === shopId);
      if (!currentShop) return;
      
      const visitData = visits[shopId] || { logs: [], wantToGo: false };
      const openStatus = getOpenStatus(currentShop.openingHours);
      const isOpen = openStatus.state !== 'closed';
      const isSoon = openStatus.state === 'soon';
      
      document.getElementById('detail-name').textContent = currentShop.name;
      document.getElementById('detail-category').textContent = currentShop.category;
      document.getElementById('detail-area').textContent = currentShop.area;
      document.getElementById('detail-description').textContent = currentShop.description;
      
      const statusBadge = document.getElementById('detail-status-badge');
      if (isSoon) {
        statusBadge.className = 'badge badge-soon';
        statusBadge.textContent = 'ÈñâÂ∫óÈñìËøë';
      } else if (isOpen) {
        statusBadge.className = 'badge badge-status';
        statusBadge.textContent = 'Âñ∂Ê•≠‰∏≠';
      } else {
        statusBadge.className = 'badge badge-closed';
        statusBadge.textContent = 'Âñ∂Ê•≠ÊôÇÈñìÂ§ñ';
      }
      
      renderHours();
      
      // Êù•Â∫óÊÉÖÂ†±„ÇíÂ∏∏„Å´Ë°®Á§∫
      if (visitData.logs.length > 0) {
        const lastVisit = visitData.logs[visitData.logs.length - 1];
        const avgRating = visitData.logs.filter(l => l.rating > 0).length > 0
          ? (visitData.logs.filter(l => l.rating > 0).reduce((a, b) => a + b.rating, 0) / 
             visitData.logs.filter(l => l.rating > 0).length).toFixed(1)
          : '-';
        
        document.getElementById('detail-visit-count').textContent = visitData.logs.length;
        document.getElementById('detail-last-visit').textContent = formatDateDetail(lastVisit.visitedAt);
        document.getElementById('detail-avg-rating').textContent = avgRating;
        
        renderVisitHistory(visitData.logs);
      } else {
        document.getElementById('detail-visit-count').textContent = '0';
        document.getElementById('detail-last-visit').textContent = '-';
        document.getElementById('detail-avg-rating').textContent = '-';
        document.getElementById('detail-visits').innerHTML = 
          '<div class="empty-state"><div class="empty-state-icon">üçú</div><div style="font-size:14px;">„Åæ„Å†Ë®™ÂïèË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div></div>';
      }
      
      const wantBtn = document.getElementById('btn-want');
      if (visitData.wantToGo) {
        wantBtn.classList.add('active');
        document.getElementById('want-icon').textContent = '‚òÖ';
      } else {
        wantBtn.classList.remove('active');
        document.getElementById('want-icon').textContent = '‚òÜ';
      }
      
      const favoriteBtn = document.getElementById('btn-favorite');
      const favoriteIcon = document.getElementById('favorite-icon');
      if (visitData.favorite) {
        favoriteBtn.classList.add('active');
        favoriteIcon.setAttribute('fill', 'currentColor');
        favoriteIcon.setAttribute('stroke', 'none');
      } else {
        favoriteBtn.classList.remove('active');
        favoriteIcon.setAttribute('fill', 'none');
        favoriteIcon.setAttribute('stroke', 'currentColor');
      }
      
      // „É™„É≥„ÇØ„ÅÆË®≠ÂÆö
      const hasGoogleMap = !!currentShop.googleMapUrl;
      const hasWebsite = !!currentShop.websiteUrl;
      
      if (currentShop.googleMapUrl) {
        document.getElementById('nav-google-map').href = currentShop.googleMapUrl;
        document.getElementById('nav-google-map').style.display = 'flex';
      } else {
        document.getElementById('nav-google-map').style.display = 'none';
      }
      
      if (currentShop.websiteUrl) {
        document.getElementById('nav-website').href = currentShop.websiteUrl;
        document.getElementById('nav-website').style.display = 'flex';
      } else {
        document.getElementById('nav-website').style.display = 'none';
      }
      
      // „É™„É≥„ÇØ„Çª„ÇØ„Ç∑„Éß„É≥ÂÖ®‰Ωì„ÅÆË°®Á§∫Âà∂Âæ°
      const linkSection = document.getElementById('link-section');
      if (hasGoogleMap || hasWebsite) {
        linkSection.style.display = 'block';
      } else {
        linkSection.style.display = 'none';
      }
      
      document.getElementById('nav-apple').href = 
        `https://maps.apple.com/?daddr=${currentShop.lat},${currentShop.lng}`;
      document.getElementById('nav-google').href = 
        `https://www.google.com/maps/dir/?api=1&destination=${currentShop.lat},${currentShop.lng}`;
      
      document.getElementById('shop-detail-modal').classList.add('active');
    }
    
    // „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÂÖ¨ÈñãÔºàLeaflet„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åã„ÇâÂëº„Å≥Âá∫„Åô„Åü„ÇÅÔºâ
    window.showShopDetail = showShopDetail;
    window.focusShop = focusShop;
    
    function closeShopDetail() {
      document.getElementById('shop-detail-modal').classList.remove('active');
    }
    
    function renderHours() {
      const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
      const dayNames = { mon: 'Êúà', tue: 'ÁÅ´', wed: 'Ê∞¥', thu: 'Êú®', fri: 'Èáë', sat: 'Âúü', sun: 'Êó•' };
      const today = days[new Date().getDay() === 0 ? 6 : new Date().getDay() - 1];
      
      const hoursHTML = days.map(day => {
        const dayData = currentShop.openingHours[day];
        const isToday = day === today;
        
        return `
          <div class="hours-row ${isToday ? 'today' : ''}">
            <span class="hours-day">${dayNames[day]}ÊõúÊó•</span>
            <span class="hours-time">
              ${dayData.times.length === 0 ? 'ÂÆö‰ºëÊó•' : 
                dayData.times.map(t => `${t.start}-${t.end}`).join(', ')}
            </span>
          </div>
        `;
      }).join('');
      
      document.getElementById('detail-hours').innerHTML = hoursHTML;
    }
    
    function renderVisitHistory(logs) {
      const historyHTML = logs.slice().reverse().map((log, idx) => {
        const originalIdx = logs.length - 1 - idx; // ÂÖÉ„ÅÆÈÖçÂàó„Åß„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
        return `
        <div class="visit-card">
          <div style="display:flex;justify-content:space-between;align-items:start;">
            <div class="visit-date">${formatDateTime(log.visitedAt)}</div>
            <div style="display:flex;gap:8px;">
              <button onclick="editVisitRecord(${originalIdx})" style="padding:4px 12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-size:12px;cursor:pointer;">Á∑®ÈõÜ</button>
              <button onclick="deleteVisitRecord(${originalIdx})" style="padding:4px 12px;background:#ef4444;color:white;border:none;border-radius:8px;font-size:12px;cursor:pointer;">ÂâäÈô§</button>
            </div>
          </div>
          ${log.weather || log.temperature || log.waitMinutes ? `
            <div class="visit-details">
              ${log.weather ? `${log.weather}` : ''}
              ${log.temperature ? ` ${log.temperature}¬∞C` : ''}
              ${log.waitMinutes ? ` ‚Ä¢ ÂæÖ„Å°ÊôÇÈñì: ${log.waitMinutes}ÂàÜ` : ''}
            </div>
          ` : ''}
          ${log.rating > 0 ? `
            <div class="visit-rating">
              ${'‚òÖ'.repeat(log.rating)}${'‚òÜ'.repeat(5 - log.rating)}
            </div>
          ` : ''}
          ${log.order ? `<div class="visit-order"><strong>Ê≥®Êñá:</strong> ${log.order}</div>` : ''}
          ${log.memo ? `<div class="visit-memo">${log.memo}</div>` : ''}
          ${log.photo ? `<img src="${log.photo}" class="visit-photo" alt="Visit photo">` : ''}
        </div>
      `;
      }).join('');
      
      document.getElementById('detail-visits').innerHTML = historyHTML;
    }
    
    function toggleWantToGo() {
      if (!currentShop) return;
      
      if (!visits[currentShop.id]) {
        visits[currentShop.id] = { logs: [], wantToGo: false, favorite: false };
      }
      
      visits[currentShop.id].wantToGo = !visits[currentShop.id].wantToGo;
      saveVisits();
      
      const wantBtn = document.getElementById('btn-want');
      if (visits[currentShop.id].wantToGo) {
        wantBtn.classList.add('active');
        document.getElementById('want-icon').textContent = '‚òÖ';
      } else {
        wantBtn.classList.remove('active');
        document.getElementById('want-icon').textContent = '‚òÜ';
      }
      
      // „É™„Çπ„Éà„Éª„Éû„ÉÉ„Éó„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
      updateMarkers();
      renderShopList();
      renderListTab();
    }
    
    function toggleFavorite() {
      if (!currentShop) return;
      
      if (!visits[currentShop.id]) {
        visits[currentShop.id] = { logs: [], wantToGo: false, favorite: false };
      }
      
      visits[currentShop.id].favorite = !visits[currentShop.id].favorite;
      saveVisits();
      
      const favoriteBtn = document.getElementById('btn-favorite');
      const favoriteIcon = document.getElementById('favorite-icon');
      if (visits[currentShop.id].favorite) {
        favoriteBtn.classList.add('active');
        favoriteIcon.setAttribute('fill', 'currentColor');
        favoriteIcon.setAttribute('stroke', 'none');
      } else {
        favoriteBtn.classList.remove('active');
        favoriteIcon.setAttribute('fill', 'none');
        favoriteIcon.setAttribute('stroke', 'currentColor');
      }
      
      // „É™„Çπ„Éà„Éª„Éû„ÉÉ„Éó„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
      updateMarkers();
      renderShopList();
      renderListTab();
    }
    
    // Record Modal
    function openRecordModal() {
      if (!currentShop) return;
      
      editingLogIndex = null; // Á∑®ÈõÜ„É¢„Éº„Éâ„Çí„É™„Çª„ÉÉ„Éà
      
      const now = new Date();
      const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
        .toISOString().slice(0, 16);
      document.getElementById('input-visited-at').value = localDateTime;
      
      document.getElementById('record-form').reset();
      document.getElementById('input-visited-at').value = localDateTime;
      currentRating = 0;
      currentPhoto = null;
      renderRatingInput();
      document.getElementById('photo-preview').style.display = 'none';
      
      // „É¢„Éº„ÉÄ„É´„ÅÆ„Çø„Ç§„Éà„É´„Çí„É™„Çª„ÉÉ„Éà
      document.querySelector('#record-modal .modal-header h2').textContent = 'Ë®™ÂïèË®òÈå≤';
      
      document.getElementById('record-modal').classList.add('active');
    }
    
    function closeRecordModal() {
      document.getElementById('record-modal').classList.remove('active');
      editingLogIndex = null; // Á∑®ÈõÜ„É¢„Éº„Éâ„Çí„É™„Çª„ÉÉ„Éà
    }
    
    function editVisitRecord(logIndex) {
      if (!currentShop) return;
      
      const log = visits[currentShop.id].logs[logIndex];
      if (!log) return;
      
      editingLogIndex = logIndex;
      
      // „Éï„Ç©„Éº„É†„Å´Êó¢Â≠ò„Éá„Éº„Çø„ÇíÂÖ•Âäõ
      document.getElementById('input-visited-at').value = log.visitedAt;
      document.getElementById('input-temp').value = log.temperature || '';
      document.getElementById('input-wait').value = log.waitMinutes || '';
      document.getElementById('input-weather').value = log.weather || '';
      document.getElementById('input-order').value = log.order || '';
      document.getElementById('input-memo').value = log.memo || '';
      
      currentRating = log.rating || 0;
      renderRatingInput();
      
      currentPhoto = log.photo || null;
      if (currentPhoto) {
        document.getElementById('preview-img').src = currentPhoto;
        document.getElementById('photo-preview').style.display = 'block';
      } else {
        document.getElementById('photo-preview').style.display = 'none';
      }
      
      // „É¢„Éº„ÉÄ„É´„ÅÆ„Çø„Ç§„Éà„É´„ÇíÂ§âÊõ¥
      document.querySelector('#record-modal .modal-header h2').textContent = 'Ë®™ÂïèË®òÈå≤„ÇíÁ∑®ÈõÜ';
      
      document.getElementById('record-modal').classList.add('active');
    }
    
    function deleteVisitRecord(logIndex) {
      if (!currentShop) return;
      
      if (!confirm('„Åì„ÅÆË®™ÂïèË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
      
      visits[currentShop.id].logs.splice(logIndex, 1);
      saveVisits();
      
      // ÁîªÈù¢„ÇíÊõ¥Êñ∞
      updateMarkers();
      renderShopList(document.getElementById('filter-category').value);
      renderListTab();
      renderLineageTab();
      showShopDetail(currentShop.id);
    }
    
    function initRecordForm() {
      const ratingContainer = document.getElementById('rating-input');
      for (let i = 1; i <= 5; i++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'star-btn';
        btn.textContent = '‚òÖ';
        btn.onclick = () => setRating(i);
        ratingContainer.appendChild(btn);
      }
    }
    
    function renderRatingInput() {
      const stars = document.querySelectorAll('.star-btn');
      stars.forEach((star, idx) => {
        if (idx < currentRating) {
          star.classList.add('active');
        } else {
          star.classList.remove('active');
        }
      });
    }
    
    function setRating(rating) {
      currentRating = rating;
      renderRatingInput();
    }
    
    function handlePhotoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        // ÁîªÂÉè„ÇíÂúßÁ∏Æ„Åó„Å¶„Åã„Çâ‰øùÂ≠ò
        compressImage(e.target.result, (compressedDataUrl) => {
          currentPhoto = compressedDataUrl;
          document.getElementById('preview-img').src = currentPhoto;
          document.getElementById('photo-preview').style.display = 'block';
        });
      };
      reader.readAsDataURL(file);
    }
    
    function compressImage(dataUrl, callback) {
      const img = new Image();
      img.onload = () => {
        // Èï∑Ëæ∫„Çí1280px„Å´Âà∂Èôê
        const MAX_SIZE = 1280;
        let width = img.width;
        let height = img.height;
        
        if (width > height && width > MAX_SIZE) {
          height = Math.round((height * MAX_SIZE) / width);
          width = MAX_SIZE;
        } else if (height > MAX_SIZE) {
          width = Math.round((width * MAX_SIZE) / height);
          height = MAX_SIZE;
        }
        
        // Canvas „ÅßÂúßÁ∏Æ
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // JPEG 0.75ÂìÅË≥™„ÅßÂá∫Âäõ
        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.75);
        callback(compressedDataUrl);
      };
      img.src = dataUrl;
    }
    
    function removePhoto() {
      currentPhoto = null;
      document.getElementById('input-photo').value = '';
      document.getElementById('photo-preview').style.display = 'none';
    }
    
    function saveVisitRecord(event) {
      event.preventDefault();
      
      if (!currentShop) {
        alert('Â∫óËàóÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        return;
      }
      
      const visitedAt = document.getElementById('input-visited-at').value;
      if (!visitedAt) {
        alert('Êù•Â∫óÊó•ÊôÇ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      
      const visitRecord = {
        visitedAt: visitedAt,
        waitMinutes: document.getElementById('input-wait').value ? parseInt(document.getElementById('input-wait').value) : null,
        temperature: document.getElementById('input-temp').value ? parseFloat(document.getElementById('input-temp').value) : null,
        weather: document.getElementById('input-weather').value || null,
        rating: currentRating,
        order: document.getElementById('input-order').value || '',
        memo: document.getElementById('input-memo').value || '',
        photo: currentPhoto || null
      };
      
      if (!visits[currentShop.id]) {
        visits[currentShop.id] = { logs: [], wantToGo: false };
      }
      
      if (editingLogIndex !== null) {
        // Á∑®ÈõÜ„É¢„Éº„Éâ: Êó¢Â≠ò„ÅÆË®òÈå≤„ÇíÊõ¥Êñ∞
        visits[currentShop.id].logs[editingLogIndex] = visitRecord;
      } else {
        // Êñ∞Ë¶èËøΩÂä†„É¢„Éº„Éâ
        visits[currentShop.id].logs.push(visitRecord);
      }
      
      saveVisits();
      editingLogIndex = null; // Á∑®ÈõÜ„É¢„Éº„Éâ„ÇíÂç≥Â∫ß„Å´„É™„Çª„ÉÉ„Éà
      
      // ÁîªÈù¢„ÇíÊõ¥Êñ∞
      setTimeout(() => {
        updateMarkers();
        renderShopList(document.getElementById('filter-category').value);
        renderListTab();
        renderLineageTab();
        
        closeRecordModal();
        showShopDetail(currentShop.id);
      }, 100);
      
      return false;
    }
    
    
    // Utility Functions
    
    function parseHHMM(str) {
      const [h, m] = str.split(':').map(Number);
      return h * 60 + m;
    }
    
    // Âñ∂Ê•≠„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíËøî„Åô: 'open' | 'soon' | 'closed'
    // soon: ÈñâÂ∫ó1ÊôÇÈñìÂâç
    function getOpenStatus(openingHours, now = new Date()) {
      if (!openingHours) return { state: 'closed', closesAt: null };
      
      const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
      const todayKey = dayKeys[now.getDay()];
      const yesterdayKey = dayKeys[(now.getDay() + 6) % 7];
      
      const today0 = new Date(now);
      today0.setHours(0, 0, 0, 0);
      const today0Ms = today0.getTime();
      const nowMs = now.getTime();
      
      function buildPeriods(dayKey, dayOffset) {
        const day = openingHours[dayKey];
        const times = day?.times || [];
        const baseMs = today0Ms + dayOffset * 24 * 60 * 60 * 1000;
        
        return times.map(t => {
          const startMin = parseHHMM(t.start);
          const endMin = parseHHMM(t.end);
          
          let startMs = baseMs + startMin * 60 * 1000;
          let endMs = baseMs + endMin * 60 * 1000;
          
          // Êó•‰ªò„Åæ„Åü„ÅéÔºà‰æã: 17:00-01:00Ôºâ
          if (endMin < startMin) {
            endMs += 24 * 60 * 60 * 1000;
          }
          
          return { startMs, endMs, start: t.start, end: t.end, dayKey, dayOffset };
        });
      }
      
      // ‰ªäÊó•„ÅÆÂñ∂Ê•≠ÊôÇÈñì
      const todayPeriods = buildPeriods(todayKey, 0);
      
      // Êò®Êó•„ÅÆÂñ∂Ê•≠ÊôÇÈñì„ÅÆ„ÅÜ„Å°„ÄåÊó•‰ªò„Åæ„Åü„Åé„Äç„Å†„Åë„ÇíÂºï„ÅçÁ∂ô„ÅêÔºàÊ∑±Â§úÂÅ¥Ôºâ
      const yesterdayPeriodsAll = buildPeriods(yesterdayKey, -1);
      const yesterdaySpill = yesterdayPeriodsAll.filter(p => parseHHMM(p.end) < parseHHMM(p.start));
      
      const allPeriods = [...yesterdaySpill, ...todayPeriods];
      
      const active = allPeriods
        .filter(p => nowMs >= p.startMs && nowMs < p.endMs)
        .sort((a, b) => a.endMs - b.endMs)[0];
      
      if (!active) return { state: 'closed', closesAt: null };
      
      const minutesLeft = (active.endMs - nowMs) / 60000;
      
      // ÈñâÂ∫ó1ÊôÇÈñìÂâç„Å†„Åë„ÄåÈñâÂ∫óÈñìËøë„Äç
      if (minutesLeft > 0 && minutesLeft <= 60) {
        return { state: 'soon', closesAt: new Date(active.endMs) };
      }
      return { state: 'open', closesAt: new Date(active.endMs) };
    }
    
    // Êó¢Â≠ò„Ç≥„Éº„Éâ‰∫íÊèõÁî®Ôºà„Éï„Ç£„É´„Çø„Åß‰Ωø„Å£„Å¶„Çã„ÅÆ„ÅßÊÆã„ÅôÔºâ
    function isOpenNow(openingHours) {
      return getOpenStatus(openingHours).state !== 'closed';
    }
    
    function getTodayHours(openingHours) {
      if (!openingHours) return 'Âñ∂Ê•≠ÊôÇÈñìÊÉÖÂ†±„Å™„Åó';
      
      const now = new Date();
      const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
      const today = days[now.getDay()];
      
      const todayHours = openingHours[today];
      if (!todayHours || !todayHours.times || todayHours.times.length === 0) {
        return 'ÂÆö‰ºëÊó•';
      }
      
      return todayHours.times.map(t => `${t.start}-${t.end}`).join(', ');
    }
    
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const month = date.getMonth() + 1;
      const day = date.getDate();
      return `${month}/${day}`;
    }
    
    function formatDateDetail(dateStr) {
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      return `${year}Âπ¥${month}Êúà${day}Êó•`;
    }
    
    function formatDateTime(dateStr) {
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}/${month}/${day} ${hours}:${minutes}`;
    }
    
    function getLineageName(lineage) {
      const names = { root: 'Á∑èÊú¨Â±±', direct: 'Áõ¥Á≥ª', derivative: 'Ê¥æÁîüÁ≥ª' };
      return names[lineage] || lineage;
    }
    
    function saveVisits() {
      try {
        localStorage.setItem('iekei-visits', JSON.stringify(visits));
        console.log('Ë®™Âïè„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', visits);
      } catch (e) {
        console.error('‰øùÂ≠ò„Ç®„É©„Éº:', e);
        alert('„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
    }
    
    // Close modals on background click
    document.getElementById('shop-detail-modal').addEventListener('click', function(e) {
      if (e.target.id === 'shop-detail-modal') {
        closeShopDetail();
      }
    });
    document.getElementById('record-modal').addEventListener('click', function(e) {
      if (e.target.id === 'record-modal') {
        closeRecordModal();
      }
    });
    
    // „Ç∞„É≠„Éº„Éê„É´ÂÖ¨ÈñãÔºàonclickÂ±ûÊÄß„Åã„ÇâÂëº„Å≥Âá∫„Åô„Åü„ÇÅÔºâ
    window.toggleFavorite = toggleFavorite;
    window.editVisitRecord = editVisitRecord;
    window.deleteVisitRecord = deleteVisitRecord;
    window.saveVisitRecord = saveVisitRecord;
  </script>
</body>
</html>
